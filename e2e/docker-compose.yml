version: '3'
services:
  wiremock:
    image: rodolpheche/wiremock
    container_name: wiremock
    networks:
      - prisoner-content-hub-etwoe
    restart: always
    ports:
      - "9091:8080"

  web:
    build:
      context: ../
      dockerfile: Dockerfile
      args:
        BUILD_NUMBER: 1
        GIT_REF: 1
        GIT_DATE: 1
    container_name: web
    networks:
      prisoner-content-hub-etwoe:
        aliases:
          - content-hub.localhost
          - berwyn.content-hub.localhost
          - bullingdon.content-hub.localhost
          - cardiff.content-hub.localhost
          - chelmsford.content-hub.localhost
          - cookhamwood.content-hub.localhost
          - erlestoke.content-hub.localhost
          - etwoe.content-hub.localhost
          - felthama.content-hub.localhost
          - felthamb.content-hub.localhost
          - garth.content-hub.localhost
          - lindholme.content-hub.localhost
          - newhall.content-hub.localhost
          - ranby.content-hub.localhost
          - stokeheath.content-hub.localhost
          - styal.content-hub.localhost
          - swaleside.content-hub.localhost
          - themount.content-hub.localhost
          - thestudio.content-hub.localhost
          - wayland.content-hub.localhost
          - werrington.content-hub.localhost
          - wetherby.content-hub.localhost
          - woodhill.content-hub.localhost
    depends_on:
      - wiremock
    restart: always
    ports:
      - "3000:3000"
    env_file: 
      - "./test-ci.env"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  playwright:
    build: .
    container_name: playwright
    networks:
      - prisoner-content-hub-etwoe
    depends_on:
      web:
        condition: service_healthy
      wiremock:
        condition: service_started
    command: npx playwright test --grep "Feature:"
    env_file:
      - "./test-ci.env"
    environment:
      - WIREMOCK_BASE_URL=http://wiremock:8080

networks:
  prisoner-content-hub-etwoe: