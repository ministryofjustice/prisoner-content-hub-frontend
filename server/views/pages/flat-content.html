{% from "../components/feedback-widget/macro.njk" import hubFeedbackWidget %}
{% from "../components/page-navigation/macro.njk" import pageNavigation %}
{% from "../components/user-details/macro.njk" import userDetails %}
{% extends "../components/template.njk" %}

{% block pageTitle %}
  {{ data.title }}
{% endblock %}

{% block head %}
  <link href="/public/stylesheets/application.css" rel="stylesheet"/>
{% endblock %}

{% block pageNavigation %}
  {{ pageNavigation({ title: title }) }}
{% endblock %}

{% block topBar %}
  {{ topBar({
    establishmentName: establishmentName,
    showBar: false,
    userName: config.userName,
    returnUrl: config.returnUrl
  }) }}
{% endblock %}

{% block userDetails %}
  {{ userDetails({
    detailsType: 'small',
    userName: config.userName
  }) }}
{% endblock %}

{% block header %}{% endblock %}
{% block homeNavigation %}{% endblock %}
{% block search %}{% endblock %}

{% block main %}
  <div class="govuk-width-container">
    <main class="govuk-main-wrapper">
      <div class="govuk-grid-row govuk-!-margin-bottom-9">
        <div class="govuk-grid-column-two-thirds">
          <h1 id="title" class="govuk-heading-xl govuk-!-margin-bottom-6 govuk-!-margin-top-3">{{data.title}}</h1>
          <p id="stand-first" class="govuk-body-l">{{data.standFirst}}</p>
          <div id="body" class="gov-uk-dynamic-content">
            {{data.description.sanitized | safe }}
          </div>
        </div>
      </div>

      <div class="govuk-hub-article-feedback">
        <p class="govuk-body">Tell us what you think:</p>
        {{ hubFeedbackWidget({
          title: data.title,
          contentId: data.id,
          contentType: data.contentType,
          feedbackId: feedbackId,
          categories: data.categories,
          secondaryTags: data.secondaryTags
        })}}
      </div>
    </main>
  </div>
{% endblock %}

{% block bodyEnd %}
  {% if data.videos %}
    <script src="/public/video.min.js"></script>
    <script>
      $(document).ready(function () {
        {% for video in data.videos %}
          initPlayer({{ loop.index }}, "{{ video[0] }}", "{{ video[1] }}");
        {% endfor %}
      });

      function initPlayer(index, imageUrl, videoUrl) {
        var playerHtml = '<video id="videoPlayer"' + index + '" class="video-js vjs-default-skin vjs-big-play-centered vjs-show-big-play-button-on-pause" controls preload="auto" poster="' + imageUrl + '" data-setup=\'{"fluid": true,"controlBar": {"children": ["playToggle","volumePanel","currentTimeDisplay","progressControl","durationDisplay","fullscreenToggle"]}}\'><source src="' + videoUrl + ' type="video/mp4"/></video>';

        $("#body p:contains('VIDEO|')")
          .filter(":first")
          .replaceWith(playerHtml);
        videojs("videoPlayer" + index, {}, function() {
          this.controls = true;
          this.preload = "auto";
          this.poster = imageUrl;
          this.fluid = true;
          this.children = {
            "controlBar": {
              "playToggle": true,
              "volumePanel": true,
              "currentTimeDisplay": true,
              "progressControl": true,
              "durationDisplay": true,
              "fullscreenToggle": true
            }
          };
        });
      }
    </script>
  {% endif %}
{% endblock %}
